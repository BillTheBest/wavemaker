<project name="testsupport" default="build" basedir=".">

    <property name="root.dir" location="../.."/>
    <import file="${root.dir}/common.build.xml"/>

    <property file="build.properties"/>

    <path id="build.classpath">
        <filelist refid="common.api.jars"/>
        <filelist refid="common.common.jars"/>
        <filelist refid="common.testsupport.jars"/>
        <pathelement location="${classes.common.dir}"/>
	<pathelement location="${junit.jar}"/>
        <!-- REVIEW 10-Sep-08 stoens@activegrid.com -->
        <!-- Circular dependency - we have to build runtime before we can build 
             testsupport, before we can build runtime tests -->
        <path location="${classes.json.dir}"/>
        <filelist refid="common.json.jars"/>
        <path location="${classes.runtime.dir}"/>
        <filelist refid="common.runtime.jars"/>
        <!-- ... and tools needs to be built too -->
        <path location="${classes.tools.dir}"/>
    </path>

    <path id="test.build.classpath">
        <path refid="build.classpath"/>
        <pathelement location="${classes.testsupport.dir}"/>
        <pathelement location="${test.classes.common.dir}"/>
        <pathelement location="${test.classes.runtime.dir}"/>
    </path>

    <target name="help" depends="common.projecthelp" 
            description="Information about available targets"/>

    <target name="clean" description="Remove class files">
        <delete dir="${build.testsupport.dir}"/>
    </target>

    <target name="build" description="Compile testsupport">
        <mkdir dir="${classes.testsupport.dir}"/>
        <javac srcdir="${src.testsupport.dir}" 
               destdir="${classes.testsupport.dir}" 
               target="${javac.target}"
               encoding="${javac.encoding}"
               debug="${javac.debug}">
            <classpath refid="build.classpath"/>
        </javac>
    </target>

    <target name="buildtest" depends="build" description="Compile tests">
        <mkdir dir="${test.classes.testsupport.dir}"/>
        <javac srcdir="${test.src.testsupport.dir}" 
               destdir="${test.classes.testsupport.dir}" 
               target="${javac.target}"
               encoding="${javac.encoding}"
               debug="${javac.debug}">
            <classpath refid="test.build.classpath"/>
        </javac>
    </target>

    <target name="test" depends="buildtest">
        <mkdir dir="${build.test.report.dir}"/>
        <property name="test.include" value="**/*Test*"/>
        <property name="test.exclude" value=""/>
        <junit printsummary="on"
               fork="true"
               forkmode="once"
               haltonfailure="false"
               showoutput="true">
            <classpath> 
                <path refid="test.build.classpath"/>
                <filelist refid="common.runtime.jars"/>
                <pathelement location="${test.classes.testsupport.dir}"/>
            </classpath>
            <formatter type="plain" usefile="false"/>
            <formatter type="xml" usefile="true"/>
            <batchtest todir="${build.test.report.dir}">
                <fileset dir="${test.classes.testsupport.dir}">
                    <include name="${test.include}"/>
                    <exclude name="${test.exclude}"/>
                    <exclude name="com/wavemaker/**/infra/**"/>
                    <exclude name="**/*$*"/>
                </fileset>
            </batchtest>

            <syspropertyset>
                <propertyset refid="common.test.properties"/>
            </syspropertyset>            
        </junit>    
    </target>

</project>
