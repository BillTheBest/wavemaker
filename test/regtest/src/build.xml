<project name="regtest" default="runTests" basedir=".">

	<property file="${propertiesFile}"/>

	<taskdef name="wmsetbrowser"
		classname="wmRuntimeBrowser"/>
   <taskdef name="checkresult"
		classname="CheckTestResult"/>
	<target name="setup">
         <mkdir dir="${regtest_home}/src/log/HTML"/>
		 <mkdir dir="${regtest_home}/src/log/HTML_Archive"/>
		 <mkdir dir="${regtest_home}/src/log/XML"/>
		 <mkdir dir="${regtest_home}/src/log/XML_Archive"/>
		 <move todir="${regtest_home}/src/log/HTML_Archive">
			<fileset dir="${regtest_home}/src/log/HTML">
				<include name="**/*.html"/>
			</fileset>
		 </move>
		 <move todir="${regtest_home}/src/log/XML_Archive">
			<fileset dir="${regtest_home}/src/log/XML">
				<include name="**/*.xml"/>
			</fileset>
		</move>
		<exec dir="${regtest_home}/scripts" executable="${regtest_home}/scripts/wmkill${exe}" os="Linux,Mac OS X">
			<arg line="firefox"/>
		</exec>
		<tstamp/>
		<condition property="isMac">
			<os family="mac"/>
		</condition>
		<condition property="isWindows">
			<os family="windows"/>
		</condition>
		<property name="prefix" value="${DSTAMP}${TSTAMP}"/> 
		<wmsetbrowser wmBrowser="${wmBrowser}"/>
	</target>

	<target name="checkBrowser" depends="setup" if="isIE">
    		<echo message="IE set"/>
	</target>
	<target name="checkBrowser1" depends="setup" if="isFirefox">
    		<echo message="Firefox set"/>
	</target>

	<target name="runTests" depends="setup,wmSamples"/>

	<target name="wmSamples" depends="openRolodex,runRolodex,openWebServices,runWebServices,checkTestResult">
	</target>

	<target name="runTestie" if="isIE">
		<antcall target="runTest" />
	</target>

	<target name="runTestff" if="isFirefox">
		<antcall target="runTest" />
	</target>

	<target name="runTestsa" if="isSafari">
		<antcall target="runTest" />
	</target>

	<!-- **************** RolodexSimple Test **************************** -->
	<target name="openRolodex" depends="setup">
		<antcall target="runTestie" >
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_openRolodex"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ie_openRolodex.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ie_openRolodex.html"/>
			<param name="browser" value="ie"/>
			<param name="killprocess" value="iexplore"/>
			<param name="exe" value="${exe}"/>
		</antcall>

		<antcall target="runTestff" >
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_openRolodex"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ff_openRolodex.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ff_openRolodex.html"/>
			<param name="browser" value="firefox"/>
			<param name="killprocess" value="firefox"/>
			<param name="exe" value="${exe}"/>
		</antcall> 

		<antcall target="runTestsa" >
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_openRolodex"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_sa_openRolodex.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_sa_openRolodex.html"/>
			<param name="browser" value="safari"/>
			<param name="killprocess" value="safari"/>
			<param name="exe" value="${exe}"/>
		</antcall>

	</target>

	<target name="runRolodex" depends="setup">
		<antcall target="setupWar">
			<param name="appname" value="RolodexSimple"/> 
			<param name="warfile" value="${installdir}/Samples/RolodexSimple/dist/RolodexSimple.war"/> 
		</antcall>
		<antcall target="runTestie" >
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_runRolodex"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ie_runRolodex.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ie_runRolodex.html"/>
			<param name="browser" value="ie"/>
			<param name="killprocess" value="iexplore"/>
			<param name="exe" value="${exe}"/>
		</antcall>

		<antcall target="runTestff" >
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_runRolodex"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ff_runRolodex.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ff_runRolodex.html"/>
			<param name="browser" value="firefox"/>
			<param name="killprocess" value="firefox"/>
			<param name="exe" value="${exe}"/>
		</antcall> 

		<antcall target="runTestsa" >
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_runRolodex"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_sa_runRolodex.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_sa_runRolodex.html"/>
			<param name="browser" value="safari"/>
			<param name="killprocess" value="safari"/>
			<param name="exe" value="${exe}"/>
		</antcall>

	</target>

	<target name="openWebServices" depends="setup">

		<antcall target="runTestie">
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_openWebServices"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ie_openWebServices.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ie_openWebServices.html"/>
			<param name="browser" value="ie"/>
			<param name="killprocess" value="iexplore"/>
			<param name="exe" value="${exe}"/>
		</antcall>
	
		<antcall target="runTestff">
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_openWebServices"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ff_openWebServices.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ff_openWebServices.html"/>
			<param name="browser" value="firefox"/>
			<param name="killprocess" value="firefox"/>
			<param name="exe" value="${exe}"/>
		</antcall> 

		<antcall target="runTestsa">
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_openWebServices"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_sa_openWebServices.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_sa_openWebServices.html"/>
			<param name="browser" value="safari"/>
			<param name="killprocess" value="safari"/>
			<param name="exe" value="${exe}"/>
		</antcall>

	</target>
	
	<target name="runWebServices" depends="setup">
		<antcall target="setupWar">
			<param name="appname" value="WebServicesSample"/> 
			<param name="warfile" value="${installdir}/Samples/WebServicesSample/dist/WebServicesSample.war"/> 
		</antcall>
		<antcall target="runTestie" >
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_runWebServices"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ie_runWebServices.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ie_runWebServices.html"/>
			<param name="browser" value="ie"/>
			<param name="killprocess" value="iexplore"/>
			<param name="exe" value="${exe}"/>
		</antcall>
	
		<antcall target="runTestff">
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_runWebServices"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_ff_runWebServices.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_ff_runWebServices.html"/>
			<param name="browser" value="firefox"/>
			<param name="killprocess" value="firefox"/>
			<param name="exe" value="${exe}"/>
		</antcall> 

		<antcall target="runTestsa">
			<param name="ts_name" value="${regtest_home}/src/suite_WaveMaker"/>
			<param name="tc_name" value="tst_runWebServices"/>
			<param name="tc_outfile_xml" value="${outdir}/XML/${prefix}_sa_runWebServices.xml"/>
			<param name="tc_outfile_html" value="${outdir}/HTML/${prefix}_sa_runWebServices.html"/>
			<param name="browser" value="safari"/>
			<param name="killprocess" value="safari"/>
			<param name="exe" value="${exe}"/>
		</antcall>

	</target>


	<!-- **************** Test Runner **************************** -->
	<target name="runTest" >
		<echo message="----------- Test Parameters ---------- "/>
		<echo message="TestSuite Name: ${ts_name}" />
		<echo message="TestCase Name: ${ts_name}" />
		<echo message="TestResult XML File: ${tc_outfile_xml}" />
		<echo message="TestResult File: ${tc_outfile_html}" />
		<echo message="------------------------------------------------ "/>
		<parallel>
			<exec dir="${squish_home}\bin" executable="squishserver${exe}" vmlauncher="no" spawn="true"/>
			<sequential>
				<sleep seconds="2"/>
				<exec dir="${squish_home}\bin" executable="squishrunner${exe}" vmlauncher="no" timeout="500000">
					<arg line="--testsuite"/>
					<arg line="${ts_name}"/>
					<arg line="--testcase"/>
					<arg line="${tc_name}"/>
					<arg line="--reportgen xml,${tc_outfile_xml}"/>
					<arg line="--webbrowser"/>
					<arg line="${browser}"/>
				</exec>
				<exec dir="${regtest_home}/scripts" executable="${regtest_home}/scripts/genhtml" vmlauncher="no" os="Mac OS X,Linux">
					<arg line="${regtest_home}/scripts"/>
					<arg line="${tc_outfile_xml}"/>
					<arg line="${tc_outfile_html}"/>
				</exec>
				<exec dir="${squish_home}/python" executable="python${exe}" vmlauncher="no" os="Windows XP,Windows Vista">
					<arg line="${regtest_home}/scripts/xmlresult2html.py"/>
					<arg line="${tc_outfile_xml} > "/>
					<arg line="${tc_outfile_html}"/>
				</exec>
				</sequential>
		</parallel>
		 <antcall target="KillProcess"/>
		 <antcall target="KillSquish"/>
	  </target>

	 <target name="KillProcess" >
			<exec dir="." executable="TaskKill${exe}" os="Windows XP,Windows Vista">
				<arg line="/F"/>
				<arg line="/IM ${killprocess}${exe}"/>
			</exec>
	
			 <!--<exec dir="${regtest_home}/scripts" executable="${regtest_home}/scripts/wmkill${exe}" os="Linux,Mac OS X">
				<arg line="${killprocess}${exe}"/>
			</exec>-->
	
	  </target>
	  

   <target name="KillSquish" >
   		<exec dir="." executable="TaskKill${exe}" os="Windows XP,Windows Vista">
			<arg line="/F"/>
			<arg line='/FI "IMAGENAME eq webhook*"'/>
		</exec>
		   		<exec dir="." executable="TaskKill${exe}" os="Windows XP,Windows Vista">
			<arg line="/F"/>
			<arg line='/FI "IMAGENAME eq squish*"'/>
		</exec>
		<exec dir="." executable="TaskKill${exe}" os="Windows XP,Windows Vista">
			<arg line="/F"/>
			<arg line='/FI "IMAGENAME eq _squish*"'/>
		</exec>
		<exec dir="${regtest_home}/scripts" executable="${regtest_home}/scripts/wmkill${exe}" os="Linux,Mac OS X">
			<arg line="squishserver"/>
		</exec>
  </target> 


  
  <target name="compileHelpers">
    <javac fork="yes"  srcdir="${regtest_home}/lib/"
           destdir="${regtest_home}/lib"
		   includes="*.java"
    >
	      <classpath>
            <pathelement path="${regtest_home}/lib/ant.jar"/>
          </classpath>
	</javac>
  </target>


 <target name="setupWar">
	<delete dir="${installdir}/Tomcat/webapps/${appname}"/>
	<mkdir dir="${installdir}/Tomcat/webapps/${appname}"/>
	<unzip src="${warfile}"
		dest="${installdir}/Tomcat/webapps/${appname}/.">
	</unzip>
 </target>


<target name="checkTestResult">
	<echo message="${outdir}/XML/"/>  
   <checkresult wmDir="${outdir}/XML/"/>  
	<antcall target="outTestResultFailure"/>
   	<antcall target="outTestResultSuccess"/> 
</target>

<target name="outTestResultFailure" if="isTestFailure">
		 <fail message="The test results have failures"/>
</target>

 <target name="outTestResultSuccess" if="isTestSuccess">
           <echo message="All tests have passed"/>
 </target>

</project>
